<link rel="import" href="/bower_components/polymer/polymer.html">

<dom-module id="wellopp-table">
	<template>
		<style>
			.table {
				overflow: auto;
				white-space: nowrap;
			}

			.header {
				text-align: center;
			}

			.row {
				display: table-row;
			}

			.col {
				display: table-cell;
				border: 1px solid grey;
				padding: 8px;
			}
		</style>
		<div class="table">
			<div class="row header">
				<template is="dom-repeat" items="[[_cols]]" as="col">
					<div class="col">
						<a href$="[[itemsApi]]?col=[[col.key]]" on-tap="_doSort">
							[[col.val]] [[_getSortIcon(col.key, sortInfo.*)]]
						</a>
					</div>
				</template>
			</div>
				<template is="dom-repeat" items="[[_items]]" as="item">
					<div class="row">
						<template is="dom-repeat" items="[[_cols]]" as="col">
							<div class="col">[[_getData(item, col.key)]]</div>
						</template>
					</div>
				</template>
		</div>
	</template>
	<script>
		'use strict';

		class WelloppTable extends Polymer.GestureEventListeners(Polymer.Element) {
			static get is() {
				return 'wellopp-table';
			}

			static get properties() {
				return {
					itemsApi: {
						type: String
					},

					columns: {
						type: Object
					},

					_items: {
						type: Array,
					},

					_cols: {
						type: Object
					},

					sortInfo: {
						type: Object,
						value: {
							col: '',
							dir: 'asc'
						}
					}
				};
			}

			connectedCallback() {
				super.connectedCallback();
				this._loadItems(this.itemsApi);

				this._cols = Object.keys(this.columns).map(key => {
	                return {
	                    key: key,
	                    val: this.columns[key]
	                };
	            });
			}

			_loadItems(url) {
				if(url.includes('?')) {
					url += `&dir=${this.sortInfo.dir}`;
				}

				let xhr = new XMLHttpRequest();
				xhr.onreadystatechange = () => {
					if(xhr.readyState == XMLHttpRequest.DONE) {
						this._items = JSON.parse(xhr.responseText);
					}
				};
				xhr.open('GET', url, true);
				xhr.send(null);
			}

			_doSort(e) {
				e.preventDefault();
				let href = e.target.href;

				// Swap sort direction
				let col = href.split('?')[1].split('=')[1].split('&')[0];
				let dir;
				if(col !== this.sortInfo.col) {
					dir = 'asc';
				}
				else {
					dir = (this.sortInfo.dir === 'asc') ? 'desc' : 'asc';
				}
				this.set('sortInfo', {col, dir});
				this._loadItems(href);
			}

			_getData(item, col) {
				return item[col];
			}

			_getSortIcon(col) {
				if(col === this.sortInfo.col) {
					return (this.sortInfo.dir === 'asc') ? '▲' : '▼';
				}
			}
		}

		customElements.define(WelloppTable.is, WelloppTable);
	</script>
</dom-module>