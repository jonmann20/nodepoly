<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="dashboard-item">
	<template>
		<style>
			/****** Initial State ******/
			:host {
				font-family: helvetica;
				color: #444;
				display: inline-block;
				vertical-align: top;
				width: 240px;
				height: 240px;
				cursor: pointer;
				margin: 15px;
				will-change: transform;
			}

			.bg {
				transition: box-shadow 0.4s cubic-bezier(0, 0, 0.3, 1);
				box-shadow:
					0 3px 6px rgba(0, 0, 0, 0.16),
					0 3px 6px rgba(0, 0, 0, 0.23);
				background: #fff;
			    height: 100%;
			    width: 100%;
			    position: absolute;
			    border-radius: 2px;
			    z-index: -1;
			    will-change: transform;
			}

			img {
				width: 240px;
				height: 140px;
				will-change: transform;
			}

			.txt {
				padding: 5px 10px 0;
				will-change: transform;
			}

			p {
				margin: 0;
			}

			.name {
				font-size: 22px;
				margin-bottom: 5px;
			}

			.description {
				font-size: 14px;
			}

			.close {
				display: none;
				position: absolute;
				top: 15px;
				right: 20px;
				font-size: 28px;
				cursor: pointer;
				padding: 5px;
			}

			.close:hover {
				background: #333;
				color: #e1e1e1;
			}

			.close:active {
				background: #777;
			}

			/****** Hover State ******/
			:host:hover .bg {
				box-shadow:
					0 19px 38px rgba(0, 0, 0, 0.30),
					0 15px 12px rgba(0, 0, 0, 0.22);
			}

			/****** Start Animation State ******/
			.bg.animate {
				transition: transform 0.4s cubic-bezier(0, 0, 0.3, 1);
			}

			img.animate {
				transition: transform 0.5s cubic-bezier(0, 0, 0.3, 1);
			}

			.txt.animate {
				transition: transform 0.6s cubic-bezier(0, 0, 0.3, 1);
			}

			/****** End Animation State ******/
			:host.expanded {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				cursor: default;
				z-index: 9;
			}

			:host.expanded .close {
				display: inline-block;
			}

			:host.expanded img {
				margin-top: 25px;
				margin-left: 25px;
			}

			:host.expanded .txt {
				margin-left: 25px;
				padding: 15px 0 0;
			}

			/****** Finished Animation State ******/
			.bg.finished {
				border-radius: 0;
				box-shadow: none !important; /* NOTE: perf hit to animate this - could move to .expanded */
			}
		</style>

		<div class="bg"></div>
		<img src="{{image}}">
		<div class="txt">
			<p class="name">{{name}}</p>
			<p class="description">{{description}}</p>
		</div>

		<a class="close">X</a>
	</template>
	<script>
		let main;
		requestAnimationFrame(() => {
			main = document.querySelector('main').getBoundingClientRect();
		});

		Polymer({
			is: 'dashboard-item',

			listeners: {
				'tap': 'expand'
			},

			ready: function() {
				this.bg = this.querySelector('.bg');
				this.txt = this.querySelector('.txt');
				this.img = this.querySelector('img');
			},

			expand: function(e, obj) {
				if(e.target.classList.contains('close')) {
					this.classList.remove('expanded');
					this.bg.classList.remove('finished');
					document.body.style.overflow = 'auto';

					this.isExpanded = false;
					return;
				}

				if(this.isExpanded) {
					return;
				}

				document.body.style.overflow = 'hidden';

				// FLIP - https://aerotwist.com/blog/flip-your-animations

				// FIRST position
				const firstBg = this.getBoundingClientRect();
				const firstImg = this.img.getBoundingClientRect();
				const firstTxt = this.txt.getBoundingClientRect();

				// LAST position
				this.classList.add('expanded');
				const lastBg = this.getBoundingClientRect(); // forces a sync layout
				const lastImg = this.img.getBoundingClientRect();
				const lastTxt = this.txt.getBoundingClientRect();

				//console.log(first, last);

				const scaleW = firstBg.width / lastBg.width;
				const scaleH = firstBg.height / lastBg.height;

				// absolute positioning is 0..mainWidth
				// transform-origin positioning is mainLeft..mainWidth-firstWidth

				// fit to [0, 1] range
				function normalize(n, min, max) {
					return Math.abs((n - min) / (max - min));
				}

				function convert(n, min, max) {
					return n * (Math.abs(max - min)) + min
				}

				const left = firstBg.left - main.left;
				const absX = normalize(left, 0, main.width - firstBg.width);
				const transformX = convert(absX, 0, main.width);

				const absY = normalize(firstBg.top, 0, main.height - firstBg.height);
				const transformY = convert(absY, 0, main.height);

				const imgX = firstImg.left - lastImg.left;
				const imgY = firstImg.top - lastImg.top;

				const PADDING = 10; // TODO: calc dynamically?

				const txtX = firstTxt.left - lastTxt.left + PADDING;
				const txtY = firstTxt.top - lastTxt.top - PADDING;

				// INVERT
				this.bg.style.transformOrigin = `${transformX}px ${transformY}px`;
				this.bg.style.transform = `scale(${scaleW}, ${scaleH})`;

				this.img.style.transform = `translate(${imgX}px, ${imgY}px)`;
				this.txt.style.transform = `translate(${txtX}px, ${txtY}px)`;

				// PLAY
				// Wait for the next frame so we know all the style changes have
				// taken hold.
				requestAnimationFrame(() => {
					// Switch on animations
					this.bg.classList.add('animate');
					this.img.classList.add('animate');
					this.txt.classList.add('animate');

					// GO GO GOOOOOO!
					this.img.style.transform = '';
					this.bg.style.transform = '';
					this.txt.style.transform = '';

					this.isExpanded = true;
				});

				// Capture the end with transitionend
				this.bg.addEventListener('transitionend', () => {
					this.bg.classList.remove('animate');
					this.bg.classList.add('finished');
				}, {once: true}); // NOTE: "once" is not supported cross-browser

				this.img.addEventListener('transitionend', () => {
					this.img.classList.remove('animate');
				}, {once: true});

				this.txt.addEventListener('transitionend', () => {
					this.txt.classList.remove('animate');
				}, {once: true});
			},

			shrink: function() {
				// TODO
			}
		});
 	</script>
</dom-module>